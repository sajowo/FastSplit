<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Podziel Rachunek</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="icon" type="image/x-icon" href="{% static 'img/favv16.png' %}" />
</head>

<body>
  <div id="toast-container"></div>

  {% if messages %}
  <script>
    window.__DJANGO_MESSAGES__ = [
      {% for message in messages %}
    { text: "{{ message|escapejs }}", tags: "{{ message.tags|escapejs }}" },
    {% endfor %}
    ];
  </script>
  {% endif %}

  <header class="topbar">
    <div class="topbar-inner">
      <div class="topbar-left">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true">
            <img class="brand-logo" src="{% static 'img/logo.png' %}" alt="" aria-hidden="true" />
          </div>
        </div>

        <section class="search-friend topbar-search">
          <form method="POST" action="{% url 'search_user' %}">
            {% csrf_token %}
            <span class="search-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" focusable="false" aria-hidden="true">
                <path
                  d="M10 2a8 8 0 1 0 4.9 14.3l4.4 4.4 1.4-1.4-4.4-4.4A8 8 0 0 0 10 2Zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12Z" />
              </svg>
            </span>
            <input type="text" name="username" id="user-search-input" placeholder="Szukaj u≈ºytkownika..."
              autocomplete="off" />
            <button type="submit" aria-label="Szukaj" class="search-submit">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" focusable="false" aria-hidden="true">
                <path
                  d="M10 2a8 8 0 1 0 4.9 14.3l4.4 4.4 1.4-1.4-4.4-4.4A8 8 0 0 0 10 2Zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12Z" />
              </svg>
            </button>
          </form>
          <div class="search-results" id="search-results" hidden></div>
        </section>
      </div>

      <div class="topbar-right">
        <div class="notifications">
          <button type="button" class="icon-btn" id="notifications-toggle" aria-expanded="false"
            aria-controls="notifications-panel" aria-label="Powiadomienia">
            <span class="notifications-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" focusable="false" aria-hidden="true">
                <path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6V11a6 6 0 1 0-12 0v5l-2 2v1h16v-1l-2-2Z" />
              </svg>
            </span>
            {% if notifications_count %}
            <span class="notifications-badge" id="notifications-badge">{{ notifications_count }}</span>
            {% else %}
            <span class="notifications-badge" id="notifications-badge" hidden>0</span>
            {% endif %}
          </button>
          <div class="notifications-panel" id="notifications-panel" hidden>
            <h3 style="margin-top: 0">Powiadomienia</h3>

            {% if friend_requests %}
            <div style="margin: 10px 0 6px 0; font-weight: 700;">Zaproszenia do znajomych</div>
            <ul class="notification-list">
              {% for req in friend_requests %}
              <li class="notification-item">
                <span>U≈ºytkownik <strong>{{ req.from_user.username }}</strong> chce Ciƒô dodaƒá do znajomych.</span>
                <div>
                  <a href="{% url 'handle_request' req.id 'accept' %}" class="btn-accept">Akceptuj</a>
                  <a href="{% url 'handle_request' req.id 'reject' %}" class="btn-reject">Odrzuƒá</a>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% endif %}

            {% if paid_bill_shares_for_creator %}
            <div style="margin: 10px 0 6px 0; font-weight: 700;">Op≈Çacone udzia≈Çy</div>
            <ul class="notification-list">
              {% for share in paid_bill_shares_for_creator %}
              <li class="notification-item">
                <span>
                  U≈ºytkownik <strong>{{ share.user.username }}</strong> op≈Çaci≈Ç udzia≈Ç w rozliczeniu:
                  <strong>{{ share.bill.description }}</strong>
                </span>
              </li>
              {% endfor %}
            </ul>
            {% endif %}

            {% if rejected_bill_shares_for_creator %}
            <div style="margin: 10px 0 6px 0; font-weight: 700;">Odrzucone udzia≈Çy</div>
            <ul class="notification-list">
              {% for share in rejected_bill_shares_for_creator %}
              <li class="notification-item">
                <span>
                  U≈ºytkownik <strong>{{ share.user.username }}</strong> odrzuci≈Ç udzia≈Ç w rozliczeniu:
                  <strong>{{ share.bill.description }}</strong>
                </span>
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>
        </div>

        <div class="switch-container">
          <label class="switch" aria-label="Tryb ciemny">
            <input type="checkbox" id="theme-switch" />
            <span class="slider round"></span>
          </label>
        </div>

        <div class="user-chip">
          {% if request.user.is_authenticated %}
          <div class="user-meta">
            <div class="user-name">{{ request.user.first_name|default:request.user.username }}</div>
          </div>
          <div class="user-avatar">{{ request.user.username|slice:":2"|upper }}</div>
          <input type="hidden" id="logged-in-user-id" value="{{ request.user.id }}" />
          <input type="hidden" id="logged-in-user-name" value="{{ request.user.username }}" />
          <a href="{% url 'logout' %}" class="logout-link">Wyloguj siƒô</a>
          {% else %}
          <a href="{% url 'login' %}" class="login-link">Zaloguj siƒô</a>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <main class="dashboard-main">
    <div class="dashboard-container">
      <section class="dashboard-grid">

        <div class="dashboard-col dashboard-left">
          <section class="create-spill dashboard-card">
            <h2>Utw√≥rz podzia≈Ç</h2>
            <form id="split-form" action="#" method="POST">
              {% csrf_token %}
              <div id="selected-friends"></div>

              <div class="form-group">
                <label for="bill-name">Nazwa rachunku:</label>
                <input type="text" id="bill-name" name="bill_name" placeholder="np. Pizza, Paliwo" required />
              </div>

              <div class="form-group">
                <label for="amount">Kwota do podzia≈Çu:</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0" placeholder="Wpisz kwotƒô" />
              </div>
              <div class="form-group">
                <label for="tip">Napiwek (%):</label>
                <input type="number" id="tip" name="tip" step="0.01" min="0" placeholder="Wpisz procent napiwku" />
              </div>
              <div id="split-details"></div>
              <button type="button" id="choose-friends-button">Wybierz znajomych</button>
              <div class="create-split-actions">
                <button type="submit">Utw√≥rz podzia≈Ç</button>
                <button type="button" id="cancel-split" class="btn-secondary">Anuluj</button>
              </div>
            </form>
            <div id="spill-results"></div>
          </section>

          <section class="friends-list dashboard-card">
            <div class="friends-container">
              <div class="friends-header">
                <div class="friends-title">
                  <span class="friends-title-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" focusable="false"
                      aria-hidden="true">
                      <path
                        d="M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3Zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3Zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13Zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5C23 14.17 18.33 13 16 13Z" />
                    </svg>
                  </span>
                  <h2>Twoi znajomi</h2>
                </div>
                <span class="friends-count">{{ friends|length }} RAZEM</span>
              </div>
              <div id="friends-list">
                {% if friends %}
                {% for friend in friends %}
                <div draggable="true" id="friend-{{ friend.id }}" data-friend-user-id="{{ friend.friend_account.id }}"
                  data-friend-username="{{ friend.friend_account.username|escapejs }}">
                  {{ friend.friend_account.username }}
                </div>
                {% endfor %}
                {% else %}
                <div>Brak znajomych.</div>
                {% endif %}
              </div>
            </div>

            <div class="create-group-container">
              <div class="group-header">
                <span class="group-title-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" focusable="false"
                    aria-hidden="true">
                    <path
                      d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4Zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4Zm9-5v2h-2v2h-2v-2h-2V9h2V7h2v2h2Z" />
                  </svg>
                </span>
                <h3>Stw√≥rz nowƒÖ grupƒô</h3>
              </div>
              <form action="{% url 'create_group' %}" method="POST">
                {% csrf_token %}
                <input type="text" name="group_name" placeholder="Nazwa grupy (np. Wakacje)" required />
                <div class="group-members-list">
                  <p class="group-hint">Wybierz cz≈Çonk√≥w:</p>
                  {% if friends %}
                  {% for friend in friends %}
                  <label>
                    <input type="checkbox" name="group_members" value="{{ friend.friend_account.id }}" />
                    {{ friend.friend_account.username }}
                  </label>
                  {% endfor %}
                  {% else %}
                  <p>Brak znajomych do dodania.</p>
                  {% endif %}
                </div>
                <button type="submit" class="btn-create-group">Utw√≥rz grupƒô</button>
              </form>
            </div>
          </section>
        </div>

        <section class="my-waiting dashboard-card dashboard-center">
          <h2>Aktywne rozliczenia</h2>
          {% if my_waiting_bills %}
          {% for bill in my_waiting_bills %}
          <div class="split-item bill-pending my-waiting-item">
            <h3>
              {{ bill.description }}
              {% if bill.waiting_rejected %}
              <small class="split-status">({{ bill.waiting_paid }}/{{ bill.waiting_total }} op≈Çacone, {{
                bill.waiting_rejected|length }} odrzucone)</small>
              {% else %}
              <small class="split-status">({{ bill.waiting_paid }}/{{ bill.waiting_total }} op≈Çacone)</small>
              {% endif %}
            </h3>
            <p><strong>{{ bill.amount }} PLN (Ca≈Ço≈õƒá)</strong></p>

            {% if bill.waiting_paid_shares %}
            <div class="split-details-box">
              <strong>Op≈Çacili:</strong>
              <ul class="split-details-list">
                {% for s in bill.waiting_paid_shares %}
                <li>
                  <span class="share-marker share-paid" aria-hidden="true">‚úÖ</span>
                  <span class="share-user">{{ s.user.username }}</span>
                  <span class="share-amount">{{ s.amount_owed|floatformat:2 }} PLN</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            {% if bill.waiting_unpaid %}
            <div class="split-details-box">
              <strong>Oczekujƒô na:</strong>
              <ul class="split-details-list">
                {% for s in bill.waiting_unpaid %}
                <li>
                  <span class="share-marker share-pending" aria-hidden="true">‚è≥</span>
                  <span class="share-user">{{ s.user.username }}</span>
                  <span class="share-amount">{{ s.amount_owed|floatformat:2 }} PLN</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            {% if bill.waiting_rejected %}
            <div class="split-details-box">
              <strong>Odrzucili:</strong>
              <ul class="split-details-list">
                {% for s in bill.waiting_rejected %}
                <li>
                  <span class="share-marker share-rejected" aria-hidden="true">‚ùå</span>
                  {{ s.user.username }}
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>

            <div class="actions">
              <a href="{% url 'update_bill' bill.id 'PAID' %}" class="action-link action-positive">‚úÖ Sfinalizuj</a>
              <a href="{% url 'update_bill' bill.id 'REJECTED' %}" class="action-link action-negative">‚ùå Odrzuƒá</a>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div>Brak oczekujƒÖcych rozlicze≈Ñ.</div>
          {% endif %}
        </section>

        <aside class="right-panel dashboard-right {% if todo_bills %}has-todo{% else %}no-todo{% endif %}">
          <div class="stats-row">
            <div class="stat-card stat-card-receive">
              <p class="stat-label">Do odebrania</p>
              <p class="stat-value">{{ amount_to_receive|floatformat:2 }} <span>PLN</span></p>
            </div>
            <div class="stat-card stat-card-pay">
              <p class="stat-label">Do zap≈Çacenia</p>
              <p class="stat-value">{{ amount_to_pay|floatformat:2 }} <span>PLN</span></p>
            </div>
          </div>

          <div class="right-section todo-section">
            <h2>Do op≈Çacenia</h2>
            <div class="right-scroll right-todo">
              {% if todo_bills %}
              {% for bill in todo_bills %}
              <div class="split-item bill-pending">
                <h3>
                  {{ bill.creator.username }}
                  <small class="split-status">(OczekujƒÖcy)</small>
                </h3>
                <p>{{ bill.description }} - <strong>{{ bill.display_amount }}</strong></p>
                <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>
                <div class="actions">
                  <form action="{% url 'pay_bill_share' bill.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="action-link action-positive">üí∏ Op≈Çaƒá</button>
                  </form>
                  <form action="{% url 'reject_bill_share' bill.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="action-link action-negative">‚ùå Odrzuƒá</button>
                  </form>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div>Brak rachunk√≥w do op≈Çacenia.</div>
              {% endif %}
            </div>
          </div>

          <div class="right-section history-section" style="margin-top: 18px;">
            <h2>Historia (ostatnie 8)</h2>
            <div class="right-scroll right-history">
              {% if history_bills %}
              {% for bill in history_bills %}
              <div
                class="split-item {% if bill.user_effective_status == 'PAID' %}bill-paid{% elif bill.user_effective_status == 'REJECTED' %}bill-rejected{% else %}bill-pending{% endif %}">
                <h3>
                  {{ bill.creator.username }}
                  <small class="split-status">({{ bill.user_status_label }})</small>
                </h3>
                <p>{{ bill.description }} - <strong>{{ bill.display_amount|default:bill.amount_per_person }}</strong>
                </p>
                <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>
              </div>
              {% endfor %}
              {% else %}
              <div>Brak historii.</div>
              {% endif %}
            </div>
          </div>
        </aside>
      </section>
    </div>
  </main>

  <div id="popup-container" style="display:none;">
    <div id="popup-content">
      <h2>Wybierz znajomych</h2>
      {% if my_groups %}
      <div class="popup-quick-select">
        <label for="group-selector">Szybki wyb√≥r (Grupa):</label>
        <select id="group-selector" onchange="selectGroupMembers(this)">
          <option value="">-- Wybierz grupƒô --</option>
          {% for group in my_groups %}
          <option value="{% for member in group.members.all %}{{ member.id }},{% endfor %}">
            {{ group.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}

      <ul id="popup-friends-list">
        {% if friends %}
        {% for friend in friends %}
        <li>
          <input type="checkbox" name="friend" value="{{ friend.friend_account.id }}"
            data-name="{{ friend.friend_account.username }}">
          {{ friend.friend_account.username }}
        </li>
        {% endfor %}
        {% else %}
        <li>Brak znajomych.</li>
        {% endif %}
      </ul>
      <button id="close-popup">Gotowe</button>
    </div>
  </div>

  <!-- Popup dla rozlicze≈Ñ z powiadomie≈Ñ -->
  <div id="bill-popup-overlay" style="display:none;">
    <div id="bill-popup" role="dialog" aria-modal="true" aria-labelledby="bill-popup-title">
      <h2 id="bill-popup-title" style="margin-top:0;">Rozliczenie</h2>
      <div id="bill-popup-body"></div>
      <div id="bill-popup-actions">
        <button type="button" id="bill-popup-close">Zamknij</button>
        <form id="bill-popup-reject-form" method="POST" style="display:inline;">
          {% csrf_token %}
          <button type="submit" id="bill-popup-reject" class="action-link action-negative">‚ùå Odrzuƒá</button>
        </form>
        <form id="bill-popup-accept-form" method="POST" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="action-link action-positive">‚úÖ Akceptuj</button>
        </form>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" integrity="sha256-lSjKY0/srUM+c9hlrcpC2e4IxXrZZLLVxMZ/8L0GkY=" crossorigin="anonymous"></script>
  <script src="{% static 'js/scripts.js' %}"></script>
</body>

</html>