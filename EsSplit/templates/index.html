<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Podziel Rachunek</title>
  <script>
    (function () {
      var saved = null;
      try { saved = localStorage.getItem('fastsplit_theme'); } catch (e) { }
      var isDark = saved === 'dark' || (saved !== 'light' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      if (isDark) document.documentElement.classList.add('dark-theme');
    })();
  </script>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="stylesheet" href="{% static 'css/accessibility.css' %}" />
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}" />
  <link rel="icon" type="image/x-icon" href="{% static 'img/favv16.png' %}" />
</head>

<body>
  <div id="toast-container"></div>

  {% if messages %}
  <script>
    window.__DJANGO_MESSAGES__ = [
      {% for message in messages %}
    { text: "{{ message|escapejs }}", tags: "{{ message.tags|escapejs }}" },
    {% endfor %}
    ];
  </script>
  {% endif %}

  <header class="topbar">
    <div class="topbar-inner">
      <div class="topbar-left">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true">
            <img class="brand-logo" src="{% static 'img/logo.png' %}" alt="" aria-hidden="true" />
          </div>
        </div>

        <section class="search-friend topbar-search">
          <form method="POST" action="{% url 'search_user' %}">
            {% csrf_token %}
            <span class="search-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" focusable="false" aria-hidden="true">
                <path
                  d="M10 2a8 8 0 1 0 4.9 14.3l4.4 4.4 1.4-1.4-4.4-4.4A8 8 0 0 0 10 2Zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12Z" />
              </svg>
            </span>
            <input type="text" name="username" id="user-search-input" placeholder="Szukaj u≈ºytkownika..."
              autocomplete="off" />
            <button type="submit" aria-label="Szukaj" class="search-submit">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" focusable="false" aria-hidden="true">
                <path
                  d="M10 2a8 8 0 1 0 4.9 14.3l4.4 4.4 1.4-1.4-4.4-4.4A8 8 0 0 0 10 2Zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12Z" />
              </svg>
            </button>
          </form>
          <div class="search-results" id="search-results" hidden></div>
        </section>
      </div>

      <div class="topbar-right">
        <div class="topbar-links" aria-label="Linki informacyjne">
          <a class="topbar-link" href="{% url 'faq' %}">FAQ</a>
          <a class="topbar-link" href="{% url 'about' %}">O nas</a>
          <a class="topbar-link" href="{% url 'terms' %}">Regulamin</a>
        </div>

        <div class="a11y-font-controls" role="group" aria-label="Rozmiar czcionki">
          <button type="button" class="a11y-font-btn" data-font-scale="0.85" aria-pressed="false"
            aria-label="Zmniejsz czcionkƒô">A-</button>
          <button type="button" class="a11y-font-btn" data-font-scale="1" aria-pressed="true"
            aria-label="Domy≈õlny rozmiar">A</button>
          <button type="button" class="a11y-font-btn" data-font-scale="1.25" aria-pressed="false"
            aria-label="Zwiƒôksz czcionkƒô">A+</button>
        </div>

        <button type="button" class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Menu">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </button>

        <div class="notifications">
          <button type="button" class="icon-btn" id="notifications-toggle" aria-expanded="false"
            aria-controls="notifications-panel" aria-label="Powiadomienia">
            <span class="notifications-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" focusable="false" aria-hidden="true">
                <path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6V11a6 6 0 1 0-12 0v5l-2 2v1h16v-1l-2-2Z" />
              </svg>
            </span>
            {% if notifications_count and notifications_count > 0 %}
            <span class="notifications-badge" id="notifications-badge">{{ notifications_count }}</span>
            {% else %}
            <span class="notifications-badge" id="notifications-badge" hidden style="display:none;"></span>
            {% endif %}
          </button>
          <div class="notifications-panel" id="notifications-panel" hidden>
            <h3 style="margin-top: 0">Powiadomienia</h3>

            <!-- Nowe rozliczenia do akceptacji (≈Çadowane przez JS) -->
            <div style="margin: 10px 0 6px 0; font-weight: 700;">Nowe rozliczenia</div>
            <ul class="notification-list" id="bill-notifications-list"></ul>
            <p id="bill-notifications-empty" style="color: #888; font-size: 0.9em;">Brak nowych rozlicze≈Ñ.</p>

            {% if friend_requests %}
            <div style="margin: 10px 0 6px 0; font-weight: 700;">Zaproszenia do znajomych</div>
            <ul class="notification-list">
              {% for req in friend_requests %}
              <li class="notification-item">
                <span>U≈ºytkownik <strong>{{ req.from_user.username }}</strong> chce Ciƒô dodaƒá do znajomych.</span>
                <div>
                  <a href="{% url 'handle_request' req.id 'accept' %}" class="btn-accept">Akceptuj</a>
                  <a href="{% url 'handle_request' req.id 'reject' %}" class="btn-reject">Odrzuƒá</a>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% endif %}

            {% if paid_bill_shares_for_creator %}
            <div style="margin: 10px 0 6px 0; font-weight: 700;">Op≈Çacone udzia≈Çy</div>
            <ul class="notification-list">
              {% for share in paid_bill_shares_for_creator %}
              <li class="notification-item">
                <span>
                  U≈ºytkownik <strong>{{ share.user.username }}</strong> op≈Çaci≈Ç udzia≈Ç w rozliczeniu:
                  <strong>{{ share.bill.description }}</strong>
                </span>
              </li>
              {% endfor %}
            </ul>
            {% endif %}

            {% if rejected_bill_shares_for_creator %}
            <div style="margin: 10px 0 6px 0; font-weight: 700;">Odrzucone udzia≈Çy</div>
            <ul class="notification-list">
              {% for share in rejected_bill_shares_for_creator %}
              <li class="notification-item">
                <span>
                  U≈ºytkownik <strong>{{ share.user.username }}</strong> odrzuci≈Ç udzia≈Ç w rozliczeniu:
                  <strong>{{ share.bill.description }}</strong>
                </span>
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>
        </div>

        <div class="switch-container">
          <label class="switch" aria-label="Tryb ciemny">
            <input type="checkbox" id="theme-switch" />
            <span class="slider round"></span>
          </label>
        </div>

        <div class="user-chip">
          {% if request.user.is_authenticated %}
          <a href="{% url 'settings' %}" class="user-profile-link" title="Ustawienia profilu">
            <div class="user-meta">
              <div class="user-name">{{ request.user.first_name|default:request.user.username }}</div>
            </div>
            <div class="user-avatar">
              {% if request.user.person.avatar %}
              <img src="{{ request.user.person.avatar.url }}" alt="Avatar" class="avatar-img">
              {% else %}
              {{ request.user.username|slice:":2"|upper }}
              {% endif %}
            </div>
          </a>
          <input type="hidden" id="logged-in-user-id" value="{{ request.user.id }}" />
          <input type="hidden" id="logged-in-user-name" value="{{ request.user.username }}" />
          <a href="{% url 'logout' %}" class="logout-link">Wyloguj siƒô</a>
          {% else %}
          <a href="{% url 'login' %}" class="login-link">Zaloguj siƒô</a>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <main class="dashboard-main">
    <div class="dashboard-container">
      <section class="dashboard-grid">

        <div class="dashboard-col dashboard-left">
          <section class="create-spill dashboard-card">
            <h2>Utw√≥rz podzia≈Ç</h2>
            <form id="split-form" action="#" method="POST">
              {% csrf_token %}
              <div id="selected-friends"></div>

              <div class="form-group">
                <label for="bill-name">Nazwa rachunku:</label>
                <input type="text" id="bill-name" name="bill_name" placeholder="np. Pizza, Paliwo" required />
              </div>

              <div class="form-group">
                <label for="amount">Kwota do podzia≈Çu:</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0" placeholder="Wpisz kwotƒô" />
              </div>
              <div class="form-group">
                <label for="tip">Napiwek (%):</label>
                <input type="number" id="tip" name="tip" step="0.01" min="0" placeholder="Wpisz procent napiwku" />
              </div>
              <div id="split-details"></div>
              <button type="button" id="choose-friends-button">Wybierz znajomych</button>
              <div class="create-split-actions">
                <button type="submit">Utw√≥rz podzia≈Ç</button>
                <button type="button" id="cancel-split" class="btn-secondary">Anuluj</button>
              </div>
            </form>
            <div id="spill-results"></div>
          </section>

          <section class="friends-list dashboard-card">
            <div class="friends-container">
              <div class="friends-header">
                <div class="friends-title">
                  <span class="friends-title-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" focusable="false"
                      aria-hidden="true">
                      <path
                        d="M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3Zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3Zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13Zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5C23 14.17 18.33 13 16 13Z" />
                    </svg>
                  </span>
                  <h2>Twoi znajomi</h2>
                </div>
                <span class="friends-count">{{ friends|length }} RAZEM</span>
              </div>
              <div id="friends-list">
                {% if friends %}
                {% for friend in friends %}
                <div draggable="true" id="friend-{{ friend.id }}" data-friend-user-id="{{ friend.friend_account.id }}"
                  data-friend-username="{{ friend.friend_account.username|escapejs }}">
                  {{ friend.friend_account.username }}
                </div>
                {% endfor %}
                {% else %}
                <div>Brak znajomych.</div>
                {% endif %}
              </div>
            </div>

            <div class="create-group-container">
              <div class="group-header">
                <span class="group-title-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" focusable="false"
                    aria-hidden="true">
                    <path
                      d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4Zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4Zm9-5v2h-2v2h-2v-2h-2V9h2V7h2v2h2Z" />
                  </svg>
                </span>
                <h3>Stw√≥rz nowƒÖ grupƒô</h3>
              </div>
              <form action="{% url 'create_group' %}" method="POST">
                {% csrf_token %}
                <input type="text" name="group_name" placeholder="Nazwa grupy (np. Wakacje)" required />
                <div class="group-members-list">
                  <p class="group-hint">Wybierz cz≈Çonk√≥w:</p>
                  {% if friends %}
                  {% for friend in friends %}
                  <label>
                    <input type="checkbox" name="group_members" value="{{ friend.friend_account.id }}" />
                    {{ friend.friend_account.username }}
                  </label>
                  {% endfor %}
                  {% else %}
                  <p>Brak znajomych do dodania.</p>
                  {% endif %}
                </div>
                <button type="submit" class="btn-create-group">Utw√≥rz grupƒô</button>
              </form>
            </div>
          </section>
        </div>

        <!-- Mobile collapsible sections container -->
        <div class="mobile-sections-container">
          <!-- Stats row for mobile -->
          <div class="stats-row">
            <div class="stat-card stat-card-receive">
              <p class="stat-label">Do odebrania</p>
              <p class="stat-value">{{ amount_to_receive|floatformat:2 }} <span>PLN</span></p>
            </div>
            <div class="stat-card stat-card-pay">
              <p class="stat-label">Do zap≈Çacenia</p>
              <p class="stat-value">{{ amount_to_pay|floatformat:2 }} <span>PLN</span></p>
            </div>
          </div>

          <div class="mobile-section collapsible-section" data-section="todo">
            <button type="button" class="section-toggle-btn" aria-expanded="false">
              <span class="section-toggle-title">üí∞ Do op≈Çacenia</span>
              <span class="section-toggle-count">{{ todo_bills|length }}</span>
              <span class="section-toggle-icon" aria-hidden="true">‚ñº</span>
            </button>
            <div class="section-content">
              {% if todo_bills %}
              {% for bill in todo_bills %}
              <div class="split-item bill-pending">
                <h3>{{ bill.creator.username }} <small class="split-status">(OczekujƒÖcy)</small></h3>
                <p>{{ bill.description }} - <strong>{{ bill.display_amount }}</strong></p>
                <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>
                <div class="actions">
                  <form action="{% url 'pay_bill_share' bill.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="action-link action-positive">üí∏ Op≈Çaƒá</button>
                  </form>
                  <form action="{% url 'reject_bill_share' bill.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="action-link action-negative">‚ùå Odrzuƒá</button>
                  </form>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="empty-state">Brak rachunk√≥w do op≈Çacenia.</div>
              {% endif %}
            </div>
          </div>

          <div class="mobile-section collapsible-section" data-section="active">
            <button type="button" class="section-toggle-btn" aria-expanded="false">
              <span class="section-toggle-title">üìã Aktywne rozliczenia</span>
              <span class="section-toggle-count">{{ my_waiting_bills|length }}</span>
              <span class="section-toggle-icon" aria-hidden="true">‚ñº</span>
            </button>
            <div class="section-content">
              {% if my_waiting_bills %}
              {% for bill in my_waiting_bills %}
              <div class="split-item bill-pending my-waiting-item">
                <h3>{{ bill.description }}
                  {% if bill.waiting_rejected %}
                  <small class="split-status">({{ bill.waiting_paid }}/{{ bill.waiting_total }} op≈Çacone, {{
                    bill.waiting_rejected|length }} odrzucone)</small>
                  {% else %}
                  <small class="split-status">({{ bill.waiting_paid }}/{{ bill.waiting_total }} op≈Çacone)</small>
                  {% endif %}
                </h3>
                <p><strong>{{ bill.amount }} PLN (Ca≈Ço≈õƒá)</strong></p>
                {% if bill.waiting_paid_shares %}
                <div class="split-details-box">
                  <strong>Op≈Çacili:</strong>
                  <ul class="split-details-list">
                    {% for s in bill.waiting_paid_shares %}
                    <li><span class="share-marker share-paid">‚úÖ</span><span class="share-user">{{ s.user.username
                        }}</span><span class="share-amount">{{ s.amount_owed|floatformat:2 }} PLN</span></li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
                {% if bill.waiting_unpaid %}
                <div class="split-details-box">
                  <strong>Oczekujƒô na:</strong>
                  <ul class="split-details-list">
                    {% for s in bill.waiting_unpaid %}
                    <li><span class="share-marker share-pending">‚è≥</span><span class="share-user">{{ s.user.username
                        }}</span><span class="share-amount">{{ s.amount_owed|floatformat:2 }} PLN</span></li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
                {% if bill.waiting_rejected %}
                <div class="split-details-box">
                  <strong>Odrzucili:</strong>
                  <ul class="split-details-list">
                    {% for s in bill.waiting_rejected %}
                    <li><span class="share-marker share-rejected">‚ùå</span>{{ s.user.username }}</li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
                <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>
                <div class="actions">
                  <a href="{% url 'update_bill' bill.id 'PAID' %}" class="action-link action-positive">‚úÖ Sfinalizuj</a>
                  <a href="{% url 'update_bill' bill.id 'REJECTED' %}" class="action-link action-negative">‚ùå Odrzuƒá</a>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="empty-state">Brak oczekujƒÖcych rozlicze≈Ñ.</div>
              {% endif %}
            </div>
          </div>

          <div class="mobile-section collapsible-section" data-section="history">
            <button type="button" class="section-toggle-btn" aria-expanded="false">
              <span class="section-toggle-title">üìú Historia</span>
              <span class="section-toggle-count">{{ history_bills|length }}</span>
              <span class="section-toggle-icon" aria-hidden="true">‚ñº</span>
            </button>
            <div class="section-content">
              {% if history_bills %}
              {% for bill in history_bills %}
              <div
                class="split-item {% if bill.user_effective_status == 'PAID' %}bill-paid{% elif bill.user_effective_status == 'REJECTED' %}bill-rejected{% else %}bill-pending{% endif %}">
                <h3>{{ bill.creator.username }} <small class="split-status">({{ bill.user_status_label }})</small></h3>
                <p>{{ bill.description }} - <strong>{{ bill.display_amount|default:bill.amount_per_person }}</strong>
                </p>
                <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>
              </div>
              {% endfor %}
              {% else %}
              <div class="empty-state">Brak historii.</div>
              {% endif %}
            </div>
          </div>
        </div>

        <section class="my-waiting dashboard-card dashboard-center">
          <h2>Aktywne rozliczenia</h2>
          {% if my_waiting_bills %}
          {% for bill in my_waiting_bills %}
          <div class="split-item bill-pending my-waiting-item">
            <h3>
              {{ bill.description }}
              {% if bill.waiting_rejected %}
              <small class="split-status">({{ bill.waiting_paid }}/{{ bill.waiting_total }} op≈Çacone, {{
                bill.waiting_rejected|length }} odrzucone)</small>
              {% else %}
              <small class="split-status">({{ bill.waiting_paid }}/{{ bill.waiting_total }} op≈Çacone)</small>
              {% endif %}
            </h3>
            <p><strong>{{ bill.amount }} PLN (Ca≈Ço≈õƒá)</strong></p>

            {% if bill.waiting_paid_shares %}
            <div class="split-details-box">
              <strong>Op≈Çacili:</strong>
              <ul class="split-details-list">
                {% for s in bill.waiting_paid_shares %}
                <li>
                  <span class="share-marker share-paid" aria-hidden="true">‚úÖ</span>
                  <span class="share-user">{{ s.user.username }}</span>
                  <span class="share-amount">{{ s.amount_owed|floatformat:2 }} PLN</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            {% if bill.waiting_unpaid %}
            <div class="split-details-box">
              <strong>Oczekujƒô na:</strong>
              <ul class="split-details-list">
                {% for s in bill.waiting_unpaid %}
                <li>
                  <span class="share-marker share-pending" aria-hidden="true">‚è≥</span>
                  <span class="share-user">{{ s.user.username }}</span>
                  <span class="share-amount">{{ s.amount_owed|floatformat:2 }} PLN</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            {% if bill.waiting_rejected %}
            <div class="split-details-box">
              <strong>Odrzucili:</strong>
              <ul class="split-details-list">
                {% for s in bill.waiting_rejected %}
                <li>
                  <span class="share-marker share-rejected" aria-hidden="true">‚ùå</span>
                  {{ s.user.username }}
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>

            <div class="actions">
              <a href="{% url 'update_bill' bill.id 'PAID' %}" class="action-link action-positive">‚úÖ Sfinalizuj</a>
              <a href="{% url 'update_bill' bill.id 'REJECTED' %}" class="action-link action-negative">‚ùå Odrzuƒá</a>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div>Brak oczekujƒÖcych rozlicze≈Ñ.</div>
          {% endif %}
        </section>

        <aside class="right-panel dashboard-right {% if todo_bills %}has-todo{% else %}no-todo{% endif %}">
          <div class="stats-row">
            <div class="stat-card stat-card-receive">
              <p class="stat-label">Do odebrania</p>
              <p class="stat-value">{{ amount_to_receive|floatformat:2 }} <span>PLN</span></p>
            </div>
            <div class="stat-card stat-card-pay">
              <p class="stat-label">Do zap≈Çacenia</p>
              <p class="stat-value">{{ amount_to_pay|floatformat:2 }} <span>PLN</span></p>
            </div>
          </div>

          <div class="right-section todo-section">
            <h2>Do op≈Çacenia</h2>
            <div class="right-scroll right-todo">
              {% if todo_bills %}
              {% for bill in todo_bills %}
              <div class="split-item bill-pending">
                <h3>
                  {{ bill.creator.username }}
                  <small class="split-status">(OczekujƒÖcy)</small>
                </h3>
                <p>{{ bill.description }} - <strong>{{ bill.display_amount }}</strong></p>
                <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>
                <div class="actions">
                  <form action="{% url 'pay_bill_share' bill.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="action-link action-positive">üí∏ Op≈Çaƒá</button>
                  </form>
                  <form action="{% url 'reject_bill_share' bill.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="action-link action-negative">‚ùå Odrzuƒá</button>
                  </form>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div>Brak rachunk√≥w do op≈Çacenia.</div>
              {% endif %}
            </div>
          </div>

          <div class="right-section history-section">
            <h2>Historia (ostatnie 8)</h2>
            <div class="right-scroll right-history">
              {% if history_bills %}
              {% for bill in history_bills %}
              <div
                class="split-item {% if bill.user_effective_status == 'PAID' %}bill-paid{% elif bill.user_effective_status == 'REJECTED' %}bill-rejected{% else %}bill-pending{% endif %}">
                <h3>
                  {{ bill.creator.username }}
                  <small class="split-status">({{ bill.user_status_label }})</small>
                </h3>
                <p>{{ bill.description }} - <strong>{{ bill.display_amount|default:bill.amount_per_person }}</strong>
                </p>
                <p class="split-date">{{ bill.date|date:"d M Y, H:i" }}</p>
              </div>
              {% endfor %}
              {% else %}
              <div>Brak historii.</div>
              {% endif %}
            </div>
          </div>
        </aside>
      </section>
    </div>
  </main>

  <div id="popup-container" style="display:none;">
    <div id="popup-content">
      <h2>Wybierz znajomych</h2>
      {% if my_groups %}
      <div class="popup-quick-select">
        <label for="group-selector">Szybki wyb√≥r (Grupa):</label>
        <select id="group-selector" onchange="selectGroupMembers(this)">
          <option value="">-- Wybierz grupƒô --</option>
          {% for group in my_groups %}
          <option value="{% for member in group.members.all %}{{ member.id }},{% endfor %}">
            {{ group.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}

      <ul id="popup-friends-list">
        {% if friends %}
        {% for friend in friends %}
        <li>
          <input type="checkbox" name="friend" value="{{ friend.friend_account.id }}"
            data-name="{{ friend.friend_account.username }}">
          {{ friend.friend_account.username }}
        </li>
        {% endfor %}
        {% else %}
        <li>Brak znajomych.</li>
        {% endif %}
      </ul>
      <button id="close-popup">Gotowe</button>
    </div>
  </div>

  <!-- Popup dla rozlicze≈Ñ z powiadomie≈Ñ -->
  <div id="bill-popup-overlay" style="display:none;">
    <div id="bill-popup" role="dialog" aria-modal="true" aria-labelledby="bill-popup-title">
      <h2 id="bill-popup-title" style="margin-top:0;">Rozliczenie</h2>
      <div id="bill-popup-body"></div>
      <div id="bill-popup-actions">
        <button type="button" id="bill-popup-close">Zamknij</button>
        <form id="bill-popup-reject-form" method="POST" style="display:inline;">
          {% csrf_token %}
          <button type="submit" id="bill-popup-reject" class="action-link action-negative">‚ùå Odrzuƒá</button>
        </form>
        <form id="bill-popup-accept-form" method="POST" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="action-link action-positive">‚úÖ Akceptuj</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>

  <!-- Mobile Menu -->
  <nav class="mobile-menu" id="mobile-menu" aria-label="Menu mobilne">
    <div class="mobile-menu-header">
      <div class="brand">
        <img class="brand-logo" src="{% static 'img/logo.png' %}" alt="FastSplit" style="width:32px;height:32px;" />
      </div>
      <button type="button" class="mobile-menu-close" id="mobile-menu-close" aria-label="Zamknij menu">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
          <path
            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
        </svg>
      </button>
    </div>

    {% if request.user.is_authenticated %}
    <div class="mobile-menu-user">
      <div class="user-avatar">
        {% if request.user.person.avatar %}
        <img src="{{ request.user.person.avatar.url }}" alt="Avatar" class="avatar-img">
        {% else %}
        {{ request.user.username|slice:":2"|upper }}
        {% endif %}
      </div>
      <div class="mobile-menu-user-info">
        <div class="mobile-menu-user-name">{{ request.user.first_name|default:request.user.username }}</div>
        <div class="mobile-menu-user-email">{{ request.user.email }}</div>
      </div>
    </div>
    {% endif %}

    <div class="mobile-menu-search">
      <form method="POST" action="{% url 'search_user' %}">
        {% csrf_token %}
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true">
          <path
            d="M10 2a8 8 0 1 0 4.9 14.3l4.4 4.4 1.4-1.4-4.4-4.4A8 8 0 0 0 10 2Zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12Z" />
        </svg>
        <input type="text" name="username" placeholder="Szukaj u≈ºytkownika..." autocomplete="off" />
        <button type="submit" aria-label="Szukaj">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true">
            <path
              d="M10 2a8 8 0 1 0 4.9 14.3l4.4 4.4 1.4-1.4-4.4-4.4A8 8 0 0 0 10 2Zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12Z" />
          </svg>
        </button>
      </form>
    </div>

    <div class="mobile-menu-nav">
      <a href="{% url 'index' %}">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
        </svg>
        Strona g≈Ç√≥wna
      </a>
      <a href="{% url 'settings' %}">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true">
          <path
            d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
        </svg>
        Ustawienia
      </a>
      <a href="{% url 'faq' %}">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true">
          <path
            d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z" />
        </svg>
        FAQ
      </a>
      <a href="{% url 'about' %}">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
        </svg>
        O nas
      </a>
      <a href="{% url 'terms' %}">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true">
          <path
            d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
        </svg>
        Regulamin
      </a>
    </div>

    <div class="mobile-menu-footer">
      <div class="theme-toggle">
        <span>Tryb ciemny</span>
        <label class="switch">
          <input type="checkbox" id="mobile-theme-switch" />
          <span class="slider round"></span>
        </label>
      </div>

      <div class="a11y-font-controls" role="group" aria-label="Rozmiar czcionki"
        style="display:flex;gap:8px;margin-top:12px;">
        <button type="button" class="a11y-font-btn" data-font-scale="0.85" aria-pressed="false"
          aria-label="Zmniejsz czcionkƒô">A-</button>
        <button type="button" class="a11y-font-btn" data-font-scale="1" aria-pressed="true"
          aria-label="Domy≈õlny rozmiar">A</button>
        <button type="button" class="a11y-font-btn" data-font-scale="1.25" aria-pressed="false"
          aria-label="Zwiƒôksz czcionkƒô">A+</button>
      </div>

      {% if request.user.is_authenticated %}
      <a href="{% url 'logout' %}" class="mobile-menu-logout">Wyloguj siƒô</a>
      {% else %}
      <a href="{% url 'login' %}" class="mobile-menu-logout" style="background:#3f51b5;">Zaloguj siƒô</a>
      {% endif %}
    </div>
  </nav>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"
    integrity="sha256-lSjKY0/srUM+c9hlrcpC2e4IxXrZZLLVxMZ/8L0GkY=" crossorigin="anonymous"></script>
  <script src="{% static 'js/scripts.js' %}"></script>
  <script src="{% static 'js/accessibility.js' %}"></script>
</body>

</html>